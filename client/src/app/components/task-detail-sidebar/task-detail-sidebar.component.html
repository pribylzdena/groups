<div class="task-sidebar-overlay" [class.active]="isSidebarOpen" (click)="toggleSidebar()"></div>
<ng-container *ngIf="task; else noTask">
  <div class="task-sidebar" [class.active]="isSidebarOpen">
      <div class="sidebar-header">
      <div class="sidebar-close" (click)="toggleSidebar()">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
        <div class="sidebar-title">
          <div class="color-indicator large" [ngStyle]="{'background-color': task.color}"></div>
          <input type="text" [(ngModel)]="task.name" class="task-name-input" placeholder="Název úkolu">
        </div>
    </div>

    <div class="sidebar-content">
      <div class="sidebar-section">
        <h4 class="section-title">Stav</h4>
        <select [(ngModel)]="task.status" class="form-control">
          <option value="Nepočato">Nepočato</option>
          <option value="Probíhá">Probíhá</option>
          <option value="Pozastaveno">Pozastaveno</option>
          <option value="Dokončeno">Dokončeno</option>
        </select>
      </div>

      <div class="sidebar-section">
        <h4 class="section-title">Priorita</h4>
        <select [(ngModel)]="task.priority" class="form-control">
          <option value="Nízká">Nízká</option>
          <option value="Střední">Střední</option>
          <option value="Vysoká">Vysoká</option>
        </select>
      </div>

      <div class="sidebar-section">
        <h4 class="section-title">Termín</h4>
        <input type="datetime-local" [(ngModel)]="editableDatetime" class="form-control">
      </div>

      <div class="sidebar-section" *ngIf="task.reminderAt || showReminderInput">
        <h4 class="section-title">Připomenutí</h4>
        <div class="reminder-control">
          <input type="datetime-local" [(ngModel)]="editableReminderDatetime" class="form-control">
          <button class="btn-icon" *ngIf="task.reminderAt" (click)="removeReminder()">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="sidebar-section" *ngIf="!task.reminderAt && !showReminderInput">
        <button class="btn-add-reminder" (click)="showReminderInput = true">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"></circle>
            <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="2"></line>
            <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2"></line>
          </svg>
          Přidat připomenutí
        </button>
      </div>

      <div class="sidebar-section">
        <h4 class="section-title">Barva</h4>
        <div class="color-picker">
          <div class="color-option" *ngFor="let color of availableColors"
               [ngStyle]="{'background-color': color}"
               [class.selected]="task.color === color"
               (click)="task.color = color">
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <h4 class="section-title">Popis</h4>
        <textarea [(ngModel)]="task.description" class="form-control description-input"
                  rows="5" placeholder="Přidejte popis úkolu..."></textarea>
      </div>
      <div class="sidebar-section assignees-section">
        <h4 class="section-title">Assignees</h4>

        <div class="assignees-input-group">
          <input type="text"
                 class="assignees-input"
                 placeholder="Hledej uživatele..."
                 [(ngModel)]="userSearchQuery"
                 [ngModelOptions]="{standalone: true}"
                 (input)="onUserSearch()"
                 (focus)="onUserSearch()">
          <button type="button" class="recipient-add-btn">
            <svg viewBox="0 0 24 24" width="16" height="16">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="9" cy="7" r="4" fill="none" stroke="currentColor" stroke-width="2"/>
              <line x1="19" y1="8" x2="19" y2="14" stroke="currentColor" stroke-width="2"/>
              <line x1="22" y1="11" x2="16" y2="11" stroke="currentColor" stroke-width="2"/>
            </svg>
            Přidat
          </button>
        </div>

        <div class="assignees-dropdown" [class.show]="showUserDropdown && filteredUsers.length > 0">
          <div *ngFor="let user of filteredUsers"
               class="assignees-dropdown-item"
               (click)="addAssignee(user)">
            {{ user.name }} ({{ user.email }})
          </div>
          <div *ngIf="filteredUsers.length === 0 && userSearchQuery"
               class="assignees-dropdown-item disabled">
            Žádní uživatelé nenalezeni
          </div>
        </div>

        <div class="current-assignees" *ngIf="task.assignees && task.assignees.length > 0">
          <div *ngFor="let assignee of task.assignees" class="assignee-tag">
            {{ assignee.name }}
            <button class="assignee-remove" (click)="removeAssignee(assignee)" type="button">
              <svg viewBox="0 0 24 24" width="14" height="14">
                <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="sidebar-section comments-section">
        <h4 class="section-title">Komentáře ({{ getCommentsCount() }})</h4>

        <div class="comments-list" *ngIf="task.comments && task.comments.length > 0; else noComments">
          <ng-container *ngFor="let comment of getSortedComments()">
            <div class="comment-item" [class.new]="isNewComment(comment.id)">
              <div class="comment-header">
                <div class="comment-author">
                  <div class="comment-avatar">
                    {{ getInitials(comment.user.name) }}
                  </div>
                  <span class="comment-name">{{ comment.user.name }}</span>
                </div>
                <div class="comment-time">
                  {{ formatCommentTime(comment.createdAt) }}
                </div>
              </div>

              <div class="comment-content">{{ comment.value }}</div>

              <div class="comment-actions">
                <button class="comment-reply-btn" (click)="startReply(comment)">
                  <svg viewBox="0 0 24 24" width="12" height="12">
                    <path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6M3 10l6-6"
                          fill="none" stroke="currentColor" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Odpovědět
                </button>
                <button class="comment-delete-btn"
                        *ngIf="canDeleteComment(comment)"
                        (click)="deleteComment(comment)">
                  <svg viewBox="0 0 24 24" width="12" height="12">
                    <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14zM10 11v6M14 11v6"
                          fill="none" stroke="currentColor" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>

            <div *ngFor="let reply of getRepliesForComment(comment.id)" class="comment-item reply">
              <div class="reply-indicator">
                Odpověď na komentář od <span class="original-author">{{ comment.user.name }}</span>
              </div>

              <div class="comment-header">
                <div class="comment-author">
                  <div class="comment-avatar">
                    {{ getInitials(reply.user.name) }}
                  </div>
                  <span class="comment-name">{{ reply.user.name }}</span>
                </div>
                <div class="comment-time">
                  {{ formatCommentTime(reply.createdAt) }}
                </div>
              </div>

              <div class="comment-content">{{ reply.value }}</div>

              <div class="comment-actions">
                <button class="comment-delete-btn"
                        *ngIf="canDeleteComment(reply)"
                        (click)="deleteComment(reply)">
                  <svg viewBox="0 0 24 24" width="12" height="12">
                    <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2-2V6h14zM10 11v6M14 11v6"
                          fill="none" stroke="currentColor" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </ng-container>
        </div>

        <ng-template #noComments>
          <div class="no-comments">
            Zatím žádné komentáře. Buďte první, kdo přidá komentář!
          </div>
        </ng-template>

        <div class="comment-form">
          <div class="comment-input-container">
      <textarea class="comment-input"
                [(ngModel)]="newCommentText"
                [ngModelOptions]="{standalone: true}"
                placeholder="Napište komentář..."
                (keydown.ctrl.enter)="submitComment()"
                #commentTextarea></textarea>
          </div>

          <div class="comment-form-actions">
            <div class="reply-info" *ngIf="replyingToComment">
              Odpovídáte na komentář od <span class="replying-to">{{ replyingToComment.user.name }}</span>
            </div>

            <div class="comment-form-buttons">
              <button class="btn-comment-cancel"
                      *ngIf="replyingToComment"
                      (click)="cancelReply()">
                Zrušit
              </button>
              <button class="btn-comment-submit"
                      [disabled]="!newCommentText?.trim()"
                      (click)="submitComment()">
                {{ replyingToComment ? 'Odpovědět' : 'Přidat komentář' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn-cancel" (click)="toggleSidebar()">Zrušit</button>
      <button class="btn-save" (click)="saveTask()">Uložit</button>
    </div>
  </div>
</ng-container>

<ng-template #noTask>
  <div class="task-sidebar" [class.active]="isSidebarOpen">
    <div class="sidebar-header">
      <div class="sidebar-close" (click)="toggleSidebar()">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="sidebar-title">
        <div class="color-indicator large"></div>
        <span>Loading...</span>
      </div>
    </div>
  </div>
</ng-template>
